---
title: "REDCapDM"
description: |
  A tidy dataset has variables in columns, observations in rows, and one
  value in each cell. This vignette introduces the theory of "tidy data"
  and shows you how it saves you time during data analysis.
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 5
    number_sections: true
package: "`REDCapDM`"
vignette: >
  %\VignetteIndexEntry{REDCapDM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls())
library(REDCapDM)
library(kableExtra)
```

<br>
<br>

# **Introduction**

The REDCapDM package will first allow us to read both data exported directly from REDCap and through an API connection. Next, it will allow us to create reports of queries such as outliers or missing values, and to track them. Finally, we will be able to preprocess previously downloaded data.

<br>
<br>

# **Functions**

Functions included in the package:

- <u>redcap_data</u>: read data.

- <u>rd_query</u>: identification of queries.

- <u>rd_event</u>: identification of events that are 'missing'.

- <u>check_queries</u>: control queries.

- <u>rd_transform</u>: data pre-processing.

- <u>rd_rlogic</u>: transformation of REDCap logic into R logic.

- <u>rd_insert_na</u>: manual entry of a 'missing' in specific variables using a filter.

<br>
<br>

# **Examples**

## **redcap_data**

Exported data from REDCap:

```{r message=FALSE, warning=FALSE, comment=NA, eval=FALSE}
datos <- redcap_data(data_path="C:/Users/username/example.r",
                     dic_path="C:/Users/username/example_dictionary.csv")
```

Data using API:

```{r eval=FALSE, message=FALSE, warning=FALSE, comment=NA}
datos_api <- redcap_data(uri ="https://redcap.idibell.cat/api/",
                         token = "55E5C3D1E83213ADA2182A4BFDEA")
```

For the examples we will use COVICAN dataset that is already included in the package. For more information use `?covican`.

```{r message=FALSE, warning=FALSE, comment=NA}
datos_redcap <- covican
```

```{r echo=FALSE, message=FALSE, warning=FALSE, comment=NA}
str(datos_redcap, max.level = 1)
```

`datos_redcap$data`:

```{r echo=FALSE, message=FALSE, warning=FALSE, comment=NA}
head(datos_redcap$data[,1:3])
```

`datos_redcap$dictionary`:

```{r echo=FALSE, message=FALSE, warning=FALSE, comment=NA}
head(datos_redcap$dictionary[,1:3])
```


## **rd_transform**

### *Raw data transformation*

```{r message=FALSE, warning=FALSE, include=FALSE}
RutinesLocals<-'S:/5_CodiR/1_Funcions/rutines'
source(file.path(RutinesLocals,'table2.R'))
```

```{r message=FALSE, warning=FALSE, comment=NA}
datos <- rd_transform(
  data = datos_redcap$data, 
  dic = datos_redcap$dictionary
)

data <- datos$data
```

As you can see, there are 4 steps in the transformation:

<ol>
<li>Recalculate autocalculated fields</li>

There were two autocalculated fields, as we see in the summary we have been able to recalculate both of them and there is one that has changed:

```{r message=FALSE, warning=FALSE, comment=NA}
data %>% 
  dplyr::select(d_birth, d_ingreso, age, age_recalc) %>% 
  dplyr::filter(age != age_recalc)
```

<li>Transformation of the checkboxes: change the names of the checkboxes to the names of their options and the name of their labels to No/Yes. Also, if the checkbox contains a door question, it changes the missings to</li>

```{r message=FALSE, warning=FALSE, comment=NA}
#Checkbox no gatekeeper

table(data$type_underlying_disease_haematological_cancer)

#Checkbox with gatekeeper: [type_underlying_disease(0)]='1'

#In the original data set:
table(datos_redcap$data$type_underlying_disease___0, datos_redcap$data$underlying_disease_hemato___1)

#In the transformed data set:
table(data$type_underlying_disease_haematological_cancer, data$underlying_disease_hemato_acute_myeloid_leukemia)
```

<li>Changes the original variables by their version in factor, except 'redcap_event_name' and 'redcap_data_access_group' which keep the two versions and the checkboxes that have already been transformed.</li>

```{r message=FALSE, warning=FALSE, comment=NA}
str(data$dm)
```

<li>Eliminates variables that contain a pattern. By default the pattern it looks for is '_complete'. In this case there was no '_complete' variable initially.</li>

</ol>

### *Data transformation and classification by event*

In order to perform the transformation by event we have to add the path where the file with the correspondence between events and forms is located. In this case, we will use the path where we have saved the file of this correspondence that we have downloaded from the COVICAN project.

```{r message=FALSE, warning=FALSE, comment=NA}

datos <- rd_transform(
             data = datos_redcap$data, 
             dic = datos_redcap$dictionary,
             event_path = "S:/5_CodiR/2_CodiR/Queries/202027COVICAN_InstrumentDesignations_2022-12-13.csv",
             final_format = "by_event"
             )

```

Now a step in the transformation has been added, which is to split the preprocessed data for each of the events in the study so that the function returns

```{r message=FALSE, warning=FALSE, comment=NA}
datos$data
```

### *Data transformation and classification by form*

To perform the transformation by form we must also add the path of the file of the events and forms

```{r message=FALSE, warning=FALSE, comment=NA}

datos <- rd_transform(data = datos_redcap$data, 
             dic = datos_redcap$dictionary,
             event_path = "S:/5_CodiR/2_CodiR/Queries/202027COVICAN_InstrumentDesignations_2022-12-13.csv",
             final_format = "by_form"
             )
```

As before, a final step is added, which consists of splitting the preprocessed data for each form of the study so that the function returns

```{r message=FALSE, warning=FALSE, comment=NA}
datos$data
```

### *Additional arguments*

<u>checkbox_labels</u>: specify the name of the categories that will have the checkbox variables. Default is No/Yes, we can change it to N/Y. 

```{r results = 'hide', echo = TRUE, message=FALSE, warning=FALSE, comment=NA}
datos <- rd_transform(
  data = datos_redcap$data, 
  dic = datos_redcap$dictionary,
  checkbox_labels = c("N", "Y")
)

data <- datos$data
```

We see how the categories of the following checkboxes have changed, for example

```{r message=FALSE, warning=FALSE, comment=NA}
table(data$type_underlying_disease_haematological_cancer)
```

<u>exclude_to_factor</u>: specify the name of a variable that we do not want to be transformed to a factor. For example, if we want the variable dm to keep its numeric version

```{r results = 'hide', echo = TRUE, message=FALSE, warning=FALSE, comment=NA}
datos <- rd_transform(
  data = datos_redcap$data, 
  dic = datos_redcap$dictionary,
  exclude_to_factor = "dm"
)

data <- datos$data
```

```{r message=FALSE, warning=FALSE, comment=NA}
table(data$dm)
```

<u>keep_labels</u>: logical argument to retain data set tags that are processed from REDCap

```{r echo=TRUE, message=FALSE, warning=FALSE, comment=NA, results = 'hide'}
datos <- rd_transform(
  data = datos_redcap$data, 
  dic = datos_redcap$dictionary,
  keep_labels = TRUE
)

data <- datos$data
```

```{r message=FALSE, warning=FALSE, comment=NA}
str(data[,1:5])
```

<u>delete_vars</u>: specify strings whereby any variables containing them will be removed from the data set. By default all variables containing '_complete' are removed. In this case we did not have any complete variables. We want for example to remove all inclusion and exclusion criteria

```{r results = 'hide', echo = TRUE, message=FALSE, warning=FALSE, comment=NA}
datos <- rd_transform(
  data = datos_redcap$data, 
  dic = datos_redcap$dictionary,
  delete_vars = c("inc_", "exc_")
)

data <- datos$data

```

```{r message=FALSE, warning=FALSE, comment=NA}
names(data)
```

<u>which_event</u>: in the event-driven transformation, specify whether you only want a specific event to be returned. For example, we only want the first visit

```{r results = 'hide', echo = TRUE, message=FALSE, warning=FALSE, comment=NA}

datos <- rd_transform(
             data = datos_redcap$data, 
             dic = datos_redcap$dictionary,
             event_path = "S:/5_CodiR/2_CodiR/Queries/202027COVICAN_InstrumentDesignations_2022-12-13.csv",
             final_format = "by_event",
             which_event = "initial_visit_arm_1"
             )

data <- datos$data
```

```{r message=FALSE, warning=FALSE, comment=NA}
table(data$redcap_event_name)
```

<u>which_form</u>: in the transformation by form, specify if you only want a specific form to be returned. For example, we only want the form demographics

```{r results = 'hide', echo = TRUE, message=FALSE, warning=FALSE, comment=NA}

datos <- rd_transform(
             data = datos_redcap$data, 
             dic = datos_redcap$dictionary,
             event_path = "S:/5_CodiR/2_CodiR/Queries/202027COVICAN_InstrumentDesignations_2022-12-13.csv",
             final_format = "by_form",
             which_form = "demographics"
             )

data <- datos$data
```

```{r message=FALSE, warning=FALSE, comment=NA}
names(data)
```

<u>wide</u>: so that the data set that is returned in the transformation by form is in wide format or not. We do this for the laboratory findings form

```{r results = 'hide', echo = TRUE, message=FALSE, warning=FALSE, comment=NA}

datos <- rd_transform(
             data = datos_redcap$data, 
             dic = datos_redcap$dictionary,
             event_path = "S:/5_CodiR/2_CodiR/Queries/202027COVICAN_InstrumentDesignations_2022-12-13.csv",
             final_format = "by_form",
             which_form = "laboratory_findings",
             wide = TRUE
             )

data <- datos$data

```

```{r message=FALSE, warning=FALSE, comment=NA}
head(data)
```

## **rd_rlogic**

It transforms the REDCap logic into logic that can be evaluated in R. This function is built into the recalculate function, but it may be useful to use it separately. Let's see how it transforms the logics of the autocalculated field calculations.

```{r message=FALSE, warning=FALSE, comment=NA}
#screening failure
rd_rlogic(logic = "if([exc_1]='1' or [inc_1]='0' or [inc_2]='0' or [inc_3]='0',1,0)",
          data = datos_redcap$data)

#age
rd_rlogic(logic = 'rounddown(datediff([d_birth],[d_ingreso],"y","dmy"),0)',
          data = datos_redcap$data)
```

## **rd_insert_na**

Function to set missing variables when a certain logic is fulfilled. Useful for example in the checkboxes that we do not have a gatekeeper. For example, we put the checkbox without gatekeeper (type_underlying_disease) to missing when the age is less than 65 years old.

```{r results = 'hide', echo = TRUE, message=FALSE, warning=FALSE, comment=NA}

datos <- rd_transform(
    data = datos_redcap$data, 
    dic = datos_redcap$dictionary
)

data <- datos$data

```

```{r message=FALSE, warning=FALSE, comment=NA}
#Before inserting missings
table2(data$type_underlying_disease_haematological_cancer)

data2 <- rd_insert_na(
  data = data,
  filter = rep("age < 65", 2),
  vars = grep("type_underlying_disease", names(data), value = TRUE)
)

#After inserting missings
table2(data2$type_underlying_disease_haematological_cancer)

```

## **rd_query**

### *Output*

```{r message=FALSE, warning=FALSE, include=FALSE}
example <- rd_query(variables = c("copd", "age"),
                         expression = c("%in%NA", "%in%NA"),
                         event = "initial_visit_arm_1",
                         dic = datos_redcap$dictionary,
                         data = datos_redcap$data)
library(knitr)
```


```{r echo=FALSE, message=FALSE, warning=FALSE, comment=NA}
kable(head(example)) %>% kableExtra::row_spec(0,bold=TRUE) %>% kableExtra::kable_styling()
```


<br>

### *Missings*

<u>Mandatory arguments</u>:

```{r message=FALSE, warning=FALSE, comment=NA}
example <- rd_query(variables = c("copd", "age"),
                         expression = c("%in%NA", "%in%NA"),
                         event = "initial_visit_arm_1",
                         dic = datos_redcap$dictionary,
                         data = datos_redcap$data)
```

<br>

<u>Optional arguments</u>:

```{r message=FALSE, warning=FALSE, comment=NA, results='hide'}
example<- rd_query(variables = c("age", "copd"),
                        variables_names = c("Age", "Chronic obstructive pulmonary disease"),#### OPCIONAL
                        expression = c("%in%NA", "%in%NA"),
                        query_name = c("Age is missing at baseline visit", "COPD"), #### OPCIONAL
                        instrument = c("Inclusión del paciente","Inclusión"),  #### OPCIONAL
                        event = "initial_visit_arm_1",
                        dic = datos_redcap$dictionary,
                        data = datos_redcap$data)
```

<br>

### *Missings in a branching logic*

<u>Sin filtro</u>:

```{r message=FALSE, warning=TRUE, comment=NA}
example <- rd_query(variables = c("age", "copd", "potassium"),
                          expression = c("%in%NA", "%in%NA", "%in%NA"),
                          event = "initial_visit_arm_1",
                          dic = datos_redcap$dictionary,
                          data=datos_redcap$data)
```


<br>

<u>Applying filter</u>:

```{r message=FALSE, warning=TRUE, comment=NA}
example <- rd_query(variables = c("potassium"),
                         expression = c("%in%NA"),
                         event = "initial_visit_arm_1",
                         dic = datos_redcap$dictionary,
                         data = datos_redcap$data,
                         filter = c("analitica_disponible=='1'"))
```

<br>

### *Expresiones*

<u>Simple</u>:

```{r message=FALSE, warning=TRUE, comment=NA}
example <- rd_query(variables=c("age"),
                         expression=c(">20"),
                         event="initial_visit_arm_1",
                         dic=datos_redcap$dictionary,
                         data=datos_redcap$data)
```

<br>

<u>Complex</u>:

```{r message=FALSE, warning=TRUE, comment=NA}
example <- rd_query(variables=c("age", "copd"),
                         expression=c("(>20 & <70) | %in%NA", "==1"),
                         event="initial_visit_arm_1",
                         dic=datos_redcap$dictionary,
                         data=datos_redcap$data)
```

<br>

### *Special cases*

<u>Same expression for all variables</u>:

```{r message=FALSE, warning=TRUE, comment=NA}
exemple <- rd_query(variables = c("copd","age","dm"),
                         expression = c("%in%NA"),
                         event = "initial_visit_arm_1",
                         dic = datos_redcap$dictionary,
                         data = datos_redcap$data)
```

<br>

<u>Not defining an event</u>:

```{r message=FALSE, warning=TRUE, comment=NA}
exemple <- rd_query(variables = c("copd"),
                         expression = c("%in%NA"),
                         dic = datos_redcap$dictionary,
                         data = datos_redcap$data)
```


<br>

### *Additional arguments*

<u>negate</u>: negation of expression used

```{r message=FALSE, warning=FALSE, comment=NA}
exemple <- rd_query(variables = c("copd"),
                         expression = c("%in%NA"),
                         negate = TRUE,
                         event = "initial_visit_arm_1",
                         dic = datos_redcap$dictionary,
                         data = datos_redcap$data)
```

<br>

<u>addTo</u>: join queries to an existing data frame

```{r message=FALSE, warning=FALSE, comment=NA}
exemple2 <- rd_query(variables = c("age"),
                         expression = c("%in%NA"),
                         event = "initial_visit_arm_1",
                         dic = datos_redcap$dictionary,
                         data=datos_redcap$data,
                         addTo = example)
```

<br>

<u>silent</u>: remove the table with the number of queries per variable

```{r message=FALSE, warning=FALSE, comment=NA}
example <- rd_query(variables = c("copd"),
                         expression = c("%in%NA"),
                         event = "initial_visit_arm_1",
                         dic = datos_redcap$dictionary,
                         data = datos_redcap$data,
                         silent = TRUE)
```

<br>

<u>report_title</u>: customize the queries table title

```{r message=FALSE, warning=FALSE, comment=NA}
example <- rd_query(variables = c("copd", "age"),
                         expression = c("%in%NA", "<20"),
                         event = "initial_visit_arm_1",
                         dic = datos_redcap$dictionary,
                         data = datos_redcap$data,
                         report_title = "Missing COPD values in the baseline event")
```

<br>

<u>report_zeros</u>: choose whether variables with zero queries should be reported in the table

```{r message=FALSE, warning=FALSE, comment=NA}
example <- rd_query(variables = c("copd", "age"),
                         expression = c("%in%NA", "<20"),
                         event = "initial_visit_arm_1",
                         dic = datos_redcap$dictionary,
                         data = datos_redcap$data,
                         report_zeros = TRUE)
```

<br>

## **rd_event**

<u>Simple</u>:

```{r message=FALSE, warning=FALSE, comment=NA}
example <- rd_event(event = "follow_up_visit_da_arm_1",
                    dic = datos_redcap$dictionary,
                    data = datos_redcap$data)
```

<br>

<u>Filter</u>:

```{r message=FALSE, warning=FALSE, comment=NA}
example <- rd_event(event = "follow_up_visit_da_arm_1",
                    filter = "screening_fail_crit==0",
                    dic = datos_redcap$dictionary,
                    data = datos_redcap$data)
```

<br>

<u>Several events</u>:

```{r message=FALSE, warning=FALSE, comment=NA}
example <- rd_event(event = c("initial_visit_arm_1","follow_up_visit_da_arm_1"),
                    filter = "screening_fail_crit==0",
                    dic = datos_redcap$dictionary,
                    data = datos_redcap$data,
                    report_zeros = TRUE)
```

## **check_queries**

```{r message=FALSE, warning=FALSE, include=FALSE}
queries_nuevas <- example[c(1:5, 10:20),] # We take only some of the previously created queries
queries_nuevas[nrow(queries_nuevas)+1,] <- c("649-20",rep("abc",8)) # we create a new query
```


```{r message=FALSE, warning=FALSE, comment=NA}
check <- check_queries(old = example, new = queries_nuevas)
```

<br>

Query control output:

```{r echo=FALSE, message=FALSE, warning=FALSE, comment=NA}
kable(head(check)) %>% kableExtra::row_spec(0,bold=TRUE) %>% kableExtra::kable_styling()
```


